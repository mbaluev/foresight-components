//treeData = JSON.parse('{"name":"flare","children":[{"name":"analytics","children":[{"name":"cluster","children":[{"name":"AgglomerativeCluster","size":3938},{"name":"CommunityStructure","size":3812},{"name":"HierarchicalCluster","size":6714},{"name":"MergeEdge","size":743}]},{"name":"graph","children":[{"name":"BetweennessCentrality","size":3534},{"name":"LinkDistance","size":5731},{"name":"MaxFlowMinCut","size":7840},{"name":"ShortestPaths","size":5914},{"name":"SpanningTree","size":3416}]},{"name":"optimization","children":[{"name":"AspectRatioBanker","size":7074}]}]},{"name":"animate","children":[{"name":"Easing","size":17010},{"name":"FunctionSequence","size":5842},{"name":"interpolate","children":[{"name":"ArrayInterpolator","size":1983},{"name":"ColorInterpolator","size":2047},{"name":"DateInterpolator","size":1375},{"name":"Interpolator","size":8746},{"name":"MatrixInterpolator","size":2202},{"name":"NumberInterpolator","size":1382},{"name":"ObjectInterpolator","size":1629},{"name":"PointInterpolator","size":1675},{"name":"RectangleInterpolator","size":2042}]},{"name":"ISchedulable","size":1041},{"name":"Parallel","size":5176},{"name":"Pause","size":449},{"name":"Scheduler","size":5593},{"name":"Sequence","size":5534},{"name":"Transition","size":9201},{"name":"Transitioner","size":19975},{"name":"TransitionEvent","size":1116},{"name":"Tween","size":6006}]},{"name":"data","children":[{"name":"converters","children":[{"name":"Converters","size":721},{"name":"DelimitedTextConverter","size":4294},{"name":"GraphMLConverter","size":9800},{"name":"IDataConverter","size":1314},{"name":"JSONConverter","size":2220}]},{"name":"DataField","size":1759},{"name":"DataSchema","size":2165},{"name":"DataSet","size":586},{"name":"DataSource","size":3331},{"name":"DataTable","size":772},{"name":"DataUtil","size":3322}]},{"name":"display","children":[{"name":"DirtySprite","size":8833},{"name":"LineSprite","size":1732},{"name":"RectSprite","size":3623},{"name":"TextSprite","size":10066}]},{"name":"flex","children":[{"name":"FlareVis","size":4116}]},{"name":"physics","children":[{"name":"DragForce","size":1082},{"name":"GravityForce","size":1336},{"name":"IForce","size":319},{"name":"NBodyForce","size":10498},{"name":"Particle","size":2822},{"name":"Simulation","size":9983},{"name":"Spring","size":2213},{"name":"SpringForce","size":1681}]},{"name":"query","children":[{"name":"AggregateExpression","size":1616},{"name":"And","size":1027},{"name":"Arithmetic","size":3891},{"name":"Average","size":891},{"name":"BinaryExpression","size":2893},{"name":"Comparison","size":5103},{"name":"CompositeExpression","size":3677},{"name":"Count","size":781},{"name":"DateUtil","size":4141},{"name":"Distinct","size":933},{"name":"Expression","size":5130},{"name":"ExpressionIterator","size":3617},{"name":"Fn","size":3240},{"name":"If","size":2732},{"name":"IsA","size":2039},{"name":"Literal","size":1214},{"name":"Match","size":3748},{"name":"Maximum","size":843},{"name":"methods","children":[{"name":"add","size":593},{"name":"and","size":330},{"name":"average","size":287},{"name":"count","size":277},{"name":"distinct","size":292},{"name":"div","size":595},{"name":"eq","size":594},{"name":"fn","size":460},{"name":"gt","size":603},{"name":"gte","size":625},{"name":"iff","size":748},{"name":"isa","size":461},{"name":"lt","size":597},{"name":"lte","size":619},{"name":"max","size":283},{"name":"min","size":283},{"name":"mod","size":591},{"name":"mul","size":603},{"name":"neq","size":599},{"name":"not","size":386},{"name":"or","size":323},{"name":"orderby","size":307},{"name":"range","size":772},{"name":"select","size":296},{"name":"stddev","size":363},{"name":"sub","size":600},{"name":"sum","size":280},{"name":"update","size":307},{"name":"variance","size":335},{"name":"where","size":299},{"name":"xor","size":354},{"name":"_","size":264}]},{"name":"Minimum","size":843},{"name":"Not","size":1554},{"name":"Or","size":970},{"name":"Query","size":13896},{"name":"Range","size":1594},{"name":"StringUtil","size":4130},{"name":"Sum","size":791},{"name":"Variable","size":1124},{"name":"Variance","size":1876},{"name":"Xor","size":1101}]},{"name":"scale","children":[{"name":"IScaleMap","size":2105},{"name":"LinearScale","size":1316},{"name":"LogScale","size":3151},{"name":"OrdinalScale","size":3770},{"name":"QuantileScale","size":2435},{"name":"QuantitativeScale","size":4839},{"name":"RootScale","size":1756},{"name":"Scale","size":4268},{"name":"ScaleType","size":1821},{"name":"TimeScale","size":5833}]},{"name":"util","children":[{"name":"Arrays","size":8258},{"name":"Colors","size":10001},{"name":"Dates","size":8217},{"name":"Displays","size":12555},{"name":"Filter","size":2324},{"name":"Geometry","size":10993},{"name":"heap","children":[{"name":"FibonacciHeap","size":9354},{"name":"HeapNode","size":1233}]},{"name":"IEvaluable","size":335},{"name":"IPredicate","size":383},{"name":"IValueProxy","size":874},{"name":"math","children":[{"name":"DenseMatrix","size":3165},{"name":"IMatrix","size":2815},{"name":"SparseMatrix","size":3366}]},{"name":"Maths","size":17705},{"name":"Orientation","size":1486},{"name":"palette","children":[{"name":"ColorPalette","size":6367},{"name":"Palette","size":1229},{"name":"ShapePalette","size":2059},{"name":"SizePalette","size":2291}]},{"name":"Property","size":5559},{"name":"Shapes","size":19118},{"name":"Sort","size":6887},{"name":"Stats","size":6557},{"name":"Strings","size":22026}]},{"name":"vis","children":[{"name":"axis","children":[{"name":"Axes","size":1302},{"name":"Axis","size":24593},{"name":"AxisGridLine","size":652},{"name":"AxisLabel","size":636},{"name":"CartesianAxes","size":6703}]},{"name":"controls","children":[{"name":"AnchorControl","size":2138},{"name":"ClickControl","size":3824},{"name":"Control","size":1353},{"name":"ControlList","size":4665},{"name":"DragControl","size":2649},{"name":"ExpandControl","size":2832},{"name":"HoverControl","size":4896},{"name":"IControl","size":763},{"name":"PanZoomControl","size":5222},{"name":"SelectionControl","size":7862},{"name":"TooltipControl","size":8435}]},{"name":"data","children":[{"name":"Data","size":20544},{"name":"DataList","size":19788},{"name":"DataSprite","size":10349},{"name":"EdgeSprite","size":3301},{"name":"NodeSprite","size":19382},{"name":"render","children":[{"name":"ArrowType","size":698},{"name":"EdgeRenderer","size":5569},{"name":"IRenderer","size":353},{"name":"ShapeRenderer","size":2247}]},{"name":"ScaleBinding","size":11275},{"name":"Tree","size":7147},{"name":"TreeBuilder","size":9930}]},{"name":"events","children":[{"name":"DataEvent","size":2313},{"name":"SelectionEvent","size":1880},{"name":"TooltipEvent","size":1701},{"name":"VisualizationEvent","size":1117}]},{"name":"legend","children":[{"name":"Legend","size":20859},{"name":"LegendItem","size":4614},{"name":"LegendRange","size":10530}]},{"name":"operator","children":[{"name":"distortion","children":[{"name":"BifocalDistortion","size":4461},{"name":"Distortion","size":6314},{"name":"FisheyeDistortion","size":3444}]},{"name":"encoder","children":[{"name":"ColorEncoder","size":3179},{"name":"Encoder","size":4060},{"name":"PropertyEncoder","size":4138},{"name":"ShapeEncoder","size":1690},{"name":"SizeEncoder","size":1830}]},{"name":"filter","children":[{"name":"FisheyeTreeFilter","size":5219},{"name":"GraphDistanceFilter","size":3165},{"name":"VisibilityFilter","size":3509}]},{"name":"IOperator","size":1286},{"name":"label","children":[{"name":"Labeler","size":9956},{"name":"RadialLabeler","size":3899},{"name":"StackedAreaLabeler","size":3202}]},{"name":"layout","children":[{"name":"AxisLayout","size":6725},{"name":"BundledEdgeRouter","size":3727},{"name":"CircleLayout","size":9317},{"name":"CirclePackingLayout","size":12003},{"name":"DendrogramLayout","size":4853},{"name":"ForceDirectedLayout","size":8411},{"name":"IcicleTreeLayout","size":4864},{"name":"IndentedTreeLayout","size":3174},{"name":"Layout","size":7881},{"name":"NodeLinkTreeLayout","size":12870},{"name":"PieLayout","size":2728},{"name":"RadialTreeLayout","size":12348},{"name":"RandomLayout","size":870},{"name":"StackedAreaLayout","size":9121},{"name":"TreeMapLayout","size":9191}]},{"name":"Operator","size":2490},{"name":"OperatorList","size":5248},{"name":"OperatorSequence","size":4190},{"name":"OperatorSwitch","size":2581},{"name":"SortOperator","size":2023}]},{"name":"Visualization","size":16540}]}]}');
treeData = JSON.parse('{"id":null,"name":"ПМФорсайт","children":[{"id":120566,"parentid":null,"name":"! Администрация главы региона","OrgId":120566,"ParentOrgId":null,"OrgName":"! Администрация главы региона","Level":1,"UserCount":21,"UserId":120562,"FullName":"Иванов Иван","PhotoUrl":"/asyst/api/file/get/e081bd39-0cb5-49ec-8b25-0e152a3a5100/medvedev_ukraina_sekonomila_bolee_100_mlrd_na_skidkah_na_gaz_iz_rossii 2222.jpg","children":[{"id":120145,"parentid":120566,"name":"Министерство спорта и физической культуры","OrgId":120145,"ParentOrgId":120566,"OrgName":"Министерство спорта и физической культуры","Level":2,"UserCount":93,"UserId":100060,"FullName":"Функциональный Администратор","PhotoUrl":"/asyst/api/file/get/32534507-bb75-4e1d-8ca9-645041efb024/mark3.jpg"},{"id":120565,"parentid":120566,"name":"Центральный Проектный Офис","OrgId":120565,"ParentOrgId":120566,"OrgName":"Центральный Проектный Офис","Level":2,"UserCount":93,"UserId":120156,"FullName":"Елсакова Раиса Васильевна","PhotoUrl":"/asyst/api/file/get/a49dde89-e342-4e1e-8f0e-e06e5cd1bf79/er.jpg"},{"id":120166,"parentid":120566,"name":"Министерство социальной защиты населения","OrgId":120166,"ParentOrgId":120566,"OrgName":"Министерство социальной защиты населения","Level":2,"UserCount":93,"UserId":120181,"FullName":"Михеев Игорь","PhotoUrl":"null"},{"id":120167,"parentid":120566,"name":"Министерство строительства и архитектуры","OrgId":120167,"ParentOrgId":120566,"OrgName":"Министерство строительства и архитектуры","Level":2,"UserCount":93,"UserId":120489,"FullName":"Арестов Александр Филиппович","PhotoUrl":"null"},{"id":120148,"parentid":120566,"name":"Министерство целевых программ","OrgId":120148,"ParentOrgId":120566,"OrgName":"Министерство целевых программ","Level":2,"UserCount":93,"UserId":120491,"FullName":"Бочкарев Денис Юрьевич","PhotoUrl":"null"},{"id":120168,"parentid":120566,"name":"Министерство торговли и предпринимательства","OrgId":120168,"ParentOrgId":120566,"OrgName":"Министерство торговли и предпринимательства","Level":2,"UserCount":93,"UserId":120496,"FullName":"Волин Алексей Константинович","PhotoUrl":"null"},{"id":120165,"parentid":120566,"name":"Министерство культуры и туризма","OrgId":120165,"ParentOrgId":120566,"OrgName":"Министерство культуры и туризма","Level":2,"UserCount":93,"UserId":120497,"FullName":"Вохмянин Алексей Витальевич","PhotoUrl":"null"},{"id":120151,"parentid":120566,"name":"Министерство образования","OrgId":120151,"ParentOrgId":120566,"OrgName":"Министерство образования","Level":2,"UserCount":93,"UserId":120498,"FullName":"Головин Александр Борисович","PhotoUrl":"null"},{"id":120171,"parentid":120566,"name":"Министерство информатизации и связи","OrgId":120171,"ParentOrgId":120566,"OrgName":"Министерство информатизации и связи","Level":2,"UserCount":93,"UserId":120500,"FullName":"Горовой Александр Владимирович","PhotoUrl":"null"},{"id":120177,"parentid":120566,"name":"Министерство сельского хозяйства и продовольствия","OrgId":120177,"ParentOrgId":120566,"OrgName":"Министерство сельского хозяйства и продовольствия","Level":2,"UserCount":93,"UserId":120501,"FullName":"Городов Алексей Михайлович","PhotoUrl":"null"},{"id":120172,"parentid":120566,"name":"Министерство лесного, охотничьего хозяйства и природопользования","OrgId":120172,"ParentOrgId":120566,"OrgName":"Министерство лесного, охотничьего хозяйства и природопользования","Level":2,"UserCount":93,"UserId":120504,"FullName":"Доронкин Алексей Сергеевич","PhotoUrl":"null"},{"id":120170,"parentid":120566,"name":"Министерство здравоохранения","OrgId":120170,"ParentOrgId":120566,"OrgName":"Министерство здравоохранения","Level":2,"UserCount":93,"UserId":120505,"FullName":"Доценко Алексей Викторович","PhotoUrl":"null"},{"id":120174,"parentid":120566,"name":"Министерство печати и информации","OrgId":120174,"ParentOrgId":120566,"OrgName":"Министерство печати и информации","Level":2,"UserCount":93,"UserId":120506,"FullName":"Евсюков Александр Петрович","PhotoUrl":"null"},{"id":120175,"parentid":120566,"name":"Министерство по национальной политике","OrgId":120175,"ParentOrgId":120566,"OrgName":"Министерство по национальной политике","Level":2,"UserCount":93,"UserId":120508,"FullName":"Еременко Людмила Михайловна","PhotoUrl":"null"},{"id":120176,"parentid":120566,"name":"Министерство промышленности, науки и новых технологий","OrgId":120176,"ParentOrgId":120566,"OrgName":"Министерство промышленности, науки и новых технологий","Level":2,"UserCount":93,"UserId":120511,"FullName":"Журавский Александр Владимирович","PhotoUrl":"null"},{"id":120173,"parentid":120566,"name":"Министерство жилищно-коммунального хозяйства и гражданской защиты населения","OrgId":120173,"ParentOrgId":120566,"OrgName":"Министерство жилищно-коммунального хозяйства и гражданской защиты населения","Level":2,"UserCount":93,"UserId":120528,"FullName":"Ловыгин Николай Николаевич","PhotoUrl":"null"},{"id":120178,"parentid":120566,"name":"Министерство экономики ","OrgId":120178,"ParentOrgId":120566,"OrgName":"Министерство экономики ","Level":2,"UserCount":93,"UserId":120540,"FullName":"Рубан Виктор Геннадьевич","PhotoUrl":"null"},{"id":120179,"parentid":120566,"name":"Министерство энергетики и тарифной политики","OrgId":120179,"ParentOrgId":120566,"OrgName":"Министерство энергетики и тарифной политики","Level":2,"UserCount":93,"UserId":120561,"FullName":"Яковенко Максим Владимирович","PhotoUrl":"null"},{"id":120180,"parentid":120566,"name":"Министерство финансов","OrgId":120180,"ParentOrgId":120566,"OrgName":"Министерство финансов","Level":2,"UserCount":89,"UserId":133977,"FullName":"Леванов Дмитрий","PhotoUrl":"null","children":[{"id":120182,"parentid":120180,"name":"Департамент 1","OrgId":120182,"ParentOrgId":120180,"OrgName":"Департамент 1","Level":3,"UserCount":93,"UserId":120157,"FullName":"Системный Администратор","PhotoUrl":"null","children":[{"id":120185,"parentid":120182,"name":"Отдел 1.2","OrgId":120185,"ParentOrgId":120182,"OrgName":"Отдел 1.2","Level":4,"UserCount":93,"UserId":120554,"FullName":"Храпатый Максим Викторович","PhotoUrl":"null"},{"id":120184,"parentid":120182,"name":"Отдел 1.1","OrgId":120184,"ParentOrgId":120182,"OrgName":"Отдел 1.1","Level":4,"UserCount":2,"UserId":133978,"FullName":"Pink Pink Pink","PhotoUrl":"null"}]},{"id":120183,"parentid":120180,"name":"Департамент 2","OrgId":120183,"ParentOrgId":120180,"OrgName":"Департамент 2","Level":3,"UserCount":93,"UserId":120158,"FullName":"Руководитель Проектов","PhotoUrl":"/asyst/api/file/get/db320649-8435-4b43-9471-25a5693882c2/er.jpg","children":[{"id":120187,"parentid":120183,"name":"Отдел 2.2","OrgId":120187,"ParentOrgId":120183,"OrgName":"Отдел 2.2","Level":4,"UserCount":93,"UserId":120518,"FullName":"Иванов Сергей Григорьевич","PhotoUrl":"null"},{"id":120186,"parentid":120183,"name":"Отдел 2.1","OrgId":120186,"ParentOrgId":120183,"OrgName":"Отдел 2.1","Level":4,"UserCount":88,"UserId":133538,"FullName":"ргёцжда гъжнфжф тжщзжа","PhotoUrl":"null"}]}]},{"id":120169,"parentid":120566,"name":"Министерство внутренних дел","OrgId":120169,"ParentOrgId":120566,"OrgName":"Министерство внутренних дел","Level":2,"UserCount":94,"UserId":144000,"FullName":"fzak2 fzak2","PhotoUrl":"null"}]},{"id":143985,"parentid":null,"name":"12","OrgId":143985,"ParentOrgId":null,"OrgName":"12","Level":1,"UserCount":1,"UserId":133972,"FullName":"Asyst Office Service","PhotoUrl":"null"},{"id":154006,"parentid":null,"name":"Мое подразделение","OrgId":154006,"ParentOrgId":null,"OrgName":"Мое подразделение","Level":1,"UserCount":1,"UserId":133973,"FullName":"admin admin","PhotoUrl":"null"},{"id":143983,"parentid":null,"name":"новое подразделение для замещения","OrgId":143983,"ParentOrgId":null,"OrgName":"новое подразделение для замещения","Level":1,"UserCount":1,"UserId":143994,"FullName":"zamruk zamruk","PhotoUrl":"null"}]}');

// Calculate total nodes, max label length
var totalNodes = 0;
var levelNodes = [];
var maxLabelLength = 0;
var i = 0;
var duration = 300;
var root;
var margin = {
	top: 100, right: 100, bottom: 100, left: 100
};
var dims = {
	width: 100, height: 100
};
var padding = {
	top: 100,
	right: 20
};

// size of the diagram
var viewerWidth = $('#tree-container').outerWidth();
var viewerHeight = $('#tree-container').outerHeight();
var tree = d3.layout.tree().size([viewerWidth, viewerHeight]);

// define a d3 diagonal projection for use by the node paths later on.
var diagonal = d3.svg.diagonal().projection(function(d) {
	return [d.x, d.y];
});

// A recursive helper function for performing some setup by walking through all nodes
function visit(parent, visitFn, childrenFn) {
	if (!parent) return;
	visitFn(parent);
	var children = childrenFn(parent);
	if (children) {
		var count = children.length;
		for (var i = 0; i < count; i++) {
			visit(children[i], visitFn, childrenFn);
		}
	}
}
visit(treeData, function(d) {
	totalNodes++;
	d.id = totalNodes;
	maxLabelLength = Math.max(d.name.length, maxLabelLength);
}, function(d) {
	return d.children && d.children.length > 0 ? d.children : null;
});
// Call visit function to establish maxLabelLength

// sort the tree according to the node names
function sortTree() {
	tree.sort(function(a, b) {
		return b.name.toLowerCase() < a.name.toLowerCase() ? 1 : -1;
	});
}
sortTree();
// Sort the tree initially incase the JSON isn't in a sorted order.

// Define the zoom function for the zoomable tree
function zoom() {
	svgGroup.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}
var zoomListener = d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoom);
// define the zoomListener which calls the zoom function on the "zoom" event constrained within the scaleExtents

// define the baseSvg, attaching a class for styling and the zoomListener
var baseSvg = d3.select("#tree-container").append("svg")
	.attr("width", viewerWidth)
	.attr("height", viewerHeight)
	.attr("class", "overlay")
	.call(zoomListener);

// Function to center node when clicked/highlighted so node doesn't get lost when collapsing/moving with large amount of children.
function centerNode(source) {
	scale = zoomListener.scale();
	scale = 1;
	y = -source.y0;
	x = -source.x0;
	x = x * scale + viewerWidth / 2;
	y = y * scale + viewerHeight / 2;
	d3.select('g').transition()
		.duration(duration)
		.attr("transform", "translate(" + x + "," + y + ")scale(" + scale + ")");
	zoomListener.scale(scale);
	zoomListener.translate([x, y]);
}
function centerNodeId(id) {
	var source = search(id);
	centerNode(source);
}

// Toggle children function
function toggleChildren(d) {
	if (d.children) {
		d._children = d.children;
		d.children = null;
		d._collapsed = true;
	} else if (d._children) {
		d.children = d._children;
		d._children = null;
		d._collapsed = false;
	}
	return d;
}
function collapse(d) {
	if (d.children) {
		d._children = d.children;
		d._children.forEach(collapse);
		d.children = null;
		d._collapsed = true;
	}
}
function expand(d) {
	if (d._children) {
		d.children = d._children;
		d.children.forEach(expand);
		d._children = null;
		d._collapsed = false;
	}
}

// Toggle children on click.
function click(d) {
	//if (d3.event.defaultPrevented) return; // click suppressed
	d = toggleChildren(d);
	update(d);
	centerNode(d);
}
function update(source) {
	// Compute the new height, function counts total children of root node and sets tree height accordingly.
	// This prevents the layout looking squashed when new nodes are made visible or looking sparse when nodes are removed
	// This makes the layout more consistent.
	levelNodes = [];
	var childCount = function(level, n) {
		if (!levelNodes[level]) { levelNodes.push(1); }
		else { levelNodes[level]++; }
		n.level = level;
		n.index = levelNodes[level] - 1;
		if (n.children && n.children.length > 0) {
			n.children.forEach(function(d) {
				childCount(level + 1, d);
			});
		}
	};
	childCount(0, root);

	var newWidth = d3.max(levelNodes) * (dims.width + padding.right); // pixels per line
	tree = tree.size([newWidth, viewerHeight]);

	// Compute the new tree layout.
	var nodes = tree.nodes(root).reverse(),
		links = tree.links(nodes);

	// Set widths between levels based on dims.height.
	nodes.forEach(function(d) {
		d.y = (d.depth * (dims.height + padding.top)); //maxLabelLength * 10px
		// alternatively to keep a fixed scale one can set a fixed depth per level
		// Normalize for fixed-depth by commenting out below line
		// d.y = (d.depth * 500); //500px per level.
	});

	// Update the nodes…
	node = svgGroup.selectAll("g.node").data(nodes, function(d) {
			return d.id || (d.id = ++i);
		});
	renderNode(node, source);

	// Update the links…
	var link = svgGroup.selectAll("path.link")
		.data(links, function(d) {
			return d.target.id;
		});
	renderLink(link, source);

	// Stash the old positions for transition.
	nodes.forEach(function(d) {
		d.x0 = d.x;
		d.y0 = d.y;
	});
}
function renderNode(node, source) {
	// Enter any new nodes at the parent's previous position.
	var nodeEnter = node.enter().append("g")
			.attr("class", "node")
			.attr("transform", function(d) {
				return "translate(" + source.x0 + "," + source.y0 + ")";
			})
			.on("click", function(d){ return highlight(d.id); });

	nodeEnter.append("rect")
			.attr('class', 'nodeRect')
			.attr("x", -dims.width/2)
			.attr("y", -dims.height/2)
			.attr("width", dims.width)
			.attr("height", dims.height)
			.style("stroke", function(d) {
				return d._children ? "lightsteelblue" : "#ccc";
			});

	/*
	nodeEnter.append("circle")
			.attr('class', 'nodeCircleIn')
			.attr("r", 5)
			.style("fill", "#fff")
			.attr("transform", function(d) {
				return "translate(0,-" + dims.height/2 + ")";
			});
	*/

	nodeEnter.append("circle")
			.attr('class', 'nodeCircleOut')
			.attr("r", 5)
			.style("fill", function(d) {
				return (d.children || d._children) ? (d._collapsed ? 'lightsteelblue' : '#fff') : 'transparent';
			})
			.style("stroke", function(d) {
				return (d.children || d._children) ? 'steelblue' : 'transparent';
			})
			.attr("transform", function(d) {
				return "translate(0," + dims.height/2 + ")";
			})
			.on("click", function(d){ return click(d); });

	nodeEnter.append("text")
			.attr("x", function(d) {
				//return d.children || d._children ? -10 : 10;
				return 0;
			})
			.attr("dy", ".35em")
			.attr('class', 'nodeText')
			.attr("text-anchor", "middle")
			.text(function(d) {
				return d.name;
			})
			.style("fill-opacity", 0);

	// Update the text to reflect whether node has children or not.
	node.select('text')
			.attr("x", function(d) {
				//return d.children || d._children ? -10 : 10;
				return 0;
			})
			.attr("text-anchor", function(d) {
				//return d.children || d._children ? "end" : "start";
				return "middle";
			})
			.text(function(d) {
				return d.name;
			});

	// Change the circle fill depending on whether it has children and is collapsed
	node.select("circle.nodeCircleOut")
			.style("fill", function(d) {
				return (d.children || d._children) ? (d._collapsed ? 'lightsteelblue' : '#fff') : 'transparent';
			})
			.style("stroke", function(d) {
				return (d.children || d._children) ? 'steelblue' : 'transparent';
			});

	node.select("rect.nodeRect")
			.style("stroke", function(d) {
				return d.id == source.id ? '#ff5940' : d._children ? "lightsteelblue" : "#ccc";
			});

	// Transition nodes to their new position.
	var nodeUpdate = node.transition()
			.duration(duration)
			.attr("transform", function(d) {
				return "translate(" + d.x + "," + d.y + ")";
			});

	// Fade the text in
	nodeUpdate.select("text")
			.style("fill-opacity", 1);

	// Transition exiting nodes to the parent's new position.
	var nodeExit = node.exit().transition()
			.duration(duration)
			.attr("transform", function(d) {
				return "translate(" + source.x + "," + source.y + ")";
			})
			.remove();

	nodeExit.select("circle")
			.attr("r", 0);

	nodeExit.select("text")
			.style("fill-opacity", 0);
}
function renderLink(link, source) {
	// Enter any new links at the parent's previous position.
	link.enter().insert("path", "g")
			.attr("class", "link")
			.attr("d", function(d) {
				var o = {
					x: source.x0,
					y: source.y0
				};
				return diagonal({
					source: o,
					target: o
				});
			});

	// Transition links to their new position.
	link.transition()
			.duration(duration)
			.attr("d", function(d){
				var source = {x: d.source.x, y: d.source.y + dims.height/2};
				var target = {x: d.target.x, y: d.target.y - dims.height/2};
				return diagonal({source: source, target: target});
			});

	// Transition exiting nodes to the parent's new position.
	link.exit().transition()
			.duration(duration)
			.attr("d", function(d) {
				var o = {
					x: source.x,
					y: source.y
				};
				return diagonal({
					source: o,
					target: o
				});
			})
			.remove();
}

// search node
function search(id) {
	var node = null;
	visit(treeData, function(d) {
		if (d.id == id) {
			node = d;
		}
	}, function(d) {
		return d.children && d.children.length > 0 ? d.children : d._children && d._children.length > 0 ? d._children : null;
	});
	return node;
}
function searchParent(id) {
	var node = null;
	visit(treeData, function(d) {
		if (d.children && d.children.length > 0) {
			if (d.children.filter(function(c){ return c.id == id; }).length > 0) {
				node = d;
			}
		}
		if (d._children && d._children.length > 0) {
			if (d._children.filter(function(c){ return c.id == id; }).length > 0) {
				node = d;
			}
		}
	}, function(d) {
		return d.children && d.children.length > 0 ? d.children : d._children && d._children.length > 0 ? d._children : null;
	});
	return node;
}
function toggle(id) {
	var node = search(id);
	var parent = searchParent(id);
	if (parent) {
		highlight(parent.id);
		if (parent._collapsed) {
			toggleChildren(parent);
			update(parent);
			centerNode(parent);
		}
	}
	toggleChildren(node);
	update(node);
	centerNode(node);
}
function highlight(id) {
	var node = search(id);
	var parent = searchParent(id);
	if (parent) {
		highlight(parent.id);
		if (parent._collapsed) {
			toggleChildren(parent);
			update(parent);
			centerNode(parent);
		}
	}
	update(node);
	centerNode(node);
}

// Append a group which holds all nodes and which the zoom Listener can act upon.
var svgGroup = baseSvg.append("g");

// Define the root
root = treeData;
root.x0 = viewerWidth / 2;
root.y0 = viewerHeight / 2;

// Layout the tree initially and center on the root node.
root.children.forEach(collapse);
update(root);
centerNode(root);