<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />

    <link href="/asyst/css/animate.css" rel="stylesheet" />

    <link href="/asyst/css/asyst.third.min.css" rel="stylesheet" />
    <link href="/asyst/css/asyst.global.css" rel="stylesheet" />
    <link href="/asyst/css/jquery-ui-themes/smoothness/jquery-ui.css" rel="stylesheet" />
    <link href="/asyst/chosen/chosen.css" rel="stylesheet" />
    <script src="/asyst/js/asyst.globalization.js?dd2e188349a64b2aad71ea9ef9fb649f" type="text/javascript"></script>    

    <script src="/asyst/js/asyst.third_2.js" type="text/javascript"></script>
    <script src="/asyst/js/jquery.layout-latest.min.js"></script>    	
    <link href="/asyst/jsControls/radiantQ/Src/Styles/radiantq.gantt.default.css" rel="stylesheet" />
    <link href="/asyst/jsControls/radiantQ/Src/Styles/VW.Grid.css" rel="stylesheet" />
    <script src="/asyst/jsControls/radiantQ/Src/Scripts/Utils/date.js"></script>
    <script src="/asyst/jsControls/radiantQ/Src/ResourceStrings/ru-RU.js"></script>
    <script src="/asyst/jsControls/radiantQ/Src/Scripts/Utils/globalization/ru-RU.js"></script>
    <script src='/asyst/jsControls/radiantQ/Src/Scripts/VW.Grid.1.min.js'></script>
    <script src='/asyst/jsControls/radiantQ/Src/Scripts/RadiantQ-jQuery.Gantt.5.0.1.min.js'></script>

    <script src="/asyst/js/asyst.js" type="text/javascript"></script>
    <script src="/asyst/js/asyst.utils.js" type="text/javascript"></script>
    <script src="/asyst/js/application.js" type="text/javascript"></script>

    <link href="/asyst/css/asyst.gantt.css?000001" rel="stylesheet" />
    <script src="/asyst/js/asyst.gantt.js?000001" type="text/javascript"></script>    

    <script src="/asyst/api/file/get/3a482f48-8f18-4fba-a7de-d0643413bff2/js_jquery.panelscroll.js" type="text/javascript"></script> 

    <link href="/asyst/api/file/get/7697c186-9632-4567-a32e-1af1bf4f2367/css_entity.css?000001" rel="stylesheet" />
    <link href="/asyst/api/file/get/21a7fa3f-3d87-4a9d-87bc-f3ec2e53e557/css_style.css?000001" rel="stylesheet" />
    <!-- BEGIN*****[Posmitniy, 2016-12-23] Сортировка -->
    <style>
         /* Т.к. гант в ифрейме, чтобы второй раз не было плашки - дропаем её */
        div#zimbargation{display:none}
        
        span.icon.arrow-down {
            width: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid black;
            margin-top: 12px !important;
            height: 1px !important;
        }

        span.icon.arrow-up {
            width: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid black;
            margin-top: 12px !important;
            height: 1px !important;
        }

        .icon {
            margin-top: 5px;
            margin-left: 4px;
        }
    </style>
    <!-- END*****[Posmitniy, 2016-12-23] Сортировка -->
</head>
<body class='anyclass'>
    <div id='toolbar' class='gantttoolbar'>
    </div>

    <div></div>
    <div id='ganttplace' style='width:100%; height: 675px'> </div>

    <script type="text/javascript">
        var ganttNamespace = {};
        var self = this;
        var Gantt;

        var loadGantt = ganttNamespace.loadGantt = function (options) {
            Loader.show(null, 'Построение диаграммы ганта');
            setTimeout(function () { loadGanttInternal(options); }, 50);
        };

        var loadGanttInternal = function (options) {
            var ActivityId = getParameterByName('ActivityId');
            // BEGIN*****[Posmitniy, 2016-12-27] Получаем настройки из get-запроса
            options = $.extend({
                sortable: false,
                columns: null,
                getToolbarButtons: null,
                // Стандартные настройки плагина asyst.gantt.js
                pluginOptions: {
                    IsReadOnly: false
                }
            }, options);
            // END*****[Posmitniy, 2016-12-27] Получаем настройки из get-запроса


            Asyst.Gantt.registerDateEditor();
            Asyst.Gantt.registerPredecessorsEditor();
            Asyst.Gantt.registerPointTypeEditor();
            Asyst.Gantt.registerProjectStageEditor(ActivityId);

            //убивайем контрол контекстного меню, чтобы не мешалось!
            //RadiantQ.Gantt.ContextMenuImpl = {};
            //RadiantQ.ContextMenuImpl = {};

            var ganttOptions = $.extend({
                GanttTableOptions: {
                    columns: fillColumns(options)
                },
                //IsReadOnly: options.readonly,
                //EnableAlternativeRowBackground: false,
                IsProgressPercentReadOnly: true,
                FilterActivites: NameFilter
            }, options.pluginOptions);

            Gantt = new Asyst.Gantt($('#ganttplace'), ActivityId, ganttOptions);

            Gantt.AutoSave = true;
            Gantt.load(false);

            makeToolbar(options);

            // To update the Gantt Width & Height based on SampleBrowser, if any.
            if (window.parent && window.parent.FitToWindow)
                window.parent.FitToWindow();

            //if (Gantt.Tasks.length > 0)
            //    Gantt.FitToWindow();

            var timer = null;

            makeTooltips();
			
            fitGanttViewHeight();

            // BEGIN*****[Posmitniy, 2016-12-27] Сортировка
            if (options.sortable) {
                initializeSorting();
            }
            // END*****[Posmitniy, 2016-12-27] Сортировкаz


            Loader.hide();
        };

        $(document).ready(function () {
			// Загружаем asyst.importmpp.js в parent window
			parent.dynjs.load("/asyst/js/asyst.importmpp.js");

            // Возвращаем jquery.ui перебитое bootstrap'ом
            $.fn.tooltip.noConflict();
            $.fn.button.noConflict();

            var preventAutoRun = getParameterByName('preventAutoRun') == "true";
            if (!preventAutoRun) {
                loadGantt();
            }
        });

        var NameFilter = function (activity) {
            var activityName = activity.ActivityName_M();
            var text = $("#nameField").val();
            if (!text || activityName.toLowerCase().indexOf(text.toLowerCase()) >= 0)
                return true;
            else {
                var activityCode = activity.DataSource_M().Code;
                if (!text || activityCode.toLowerCase().indexOf(text.toLowerCase()) >= 0)
                    return true;
                else
                    return false;
            }
        }


        // BEGIN*****[Posmitniy, 2016-12-23] Сортировка
        var lastSortAsc, lastSortField, lastSortMethod;
        function initializeSorting() {
            var ganttControl = Gantt.$Container.data("GanttControl");
            var $tableHeader = ganttControl.GetGanttTable().uiGridHeadTable;

            var items = Gantt.$Container.data("GanttControl").options.GanttTableOptions.columns
                .map(function (el, index) { 
                    // В списке колонок откуда-то появляется первая пустая колонка.
                    // Но реально в разметке ее нет.
                    // Поэтому уменьшаю индекс на 1.
                    return { index: index - 1, column: el }; 
                })
                .filter(function (el) { return el.column.sortFieldName; })
                .map(function (el) { 
                    return {
                        column: el.index,
                        sortAsc: true,
                        sortFieldName: el.column.sortFieldName,
                        sortMethod: el.column.sortMethod
                    }; 
                });
                
            for (var i = 0; i < items.length; i++) {
                var item = items[i];

                $('th:eq(' + item.column + ')', $tableHeader).data('sort-item', item).click(function (event) {
                    var item = $(this).data('sort-item');
                    $tableHeader.find('.icon').removeClass('arrow-up').removeClass('arrow-down');

                    var $icon = $('.icon', this);
                    if ($icon.length == 0)
                        return;

                    $icon.addClass(item.sortAsc ? 'arrow-up' : 'arrow-down');

                    sort(item.sortAsc, item.sortFieldName, item.sortMethod);

                    item.sortAsc = !item.sortAsc;
                });
            }
        };
        function lastSort() {
            sort(lastSortAsc, lastSortField, lastSortMethod);
        }
        function sort(sortAsc, sortField, sortMethod) {
            lastSortAsc = sortAsc;
            lastSortField = sortField;
            lastSortMethod = sortMethod;

            var ganttControl = Gantt.$Container.data("GanttControl");
            var datasource = ganttControl.options.DataSource;
            if (!datasource)
                return;

            Gantt.AutoSave = false;

            var compareFunc = sortMethod.bind(this, sortAsc, sortField);

            var tree = arrayToTree(datasource);
            tree.sortRecursive(compareFunc);
            datasource = tree.toArray();

            //datasource.sort(compareFunc);
                
            $('#ganttplace').GanttControl("option", "DataSource", datasource);

            Gantt.AutoSave = true;
        }
        var sortText = ganttNamespace.sortText = function (sortAsc, sortField, item1, item2) {
            var val1 = item1.data[sortField];
            var val2 = item2.data[sortField];

            if (!val1)
                val1 = '';
            if (!val2)
                val2 = '';

            if (sortAsc)
                return val1.localeCompare(val2);

            return val2.localeCompare(val1);
        };
        var sortDateTime = ganttNamespace.sortDateTime = function (sortAsc, sortField, item1, item2) {
            item1 = item1.data;
            item2 = item2.data;
            var val1 = item1[sortField];
            var val2 = item2[sortField];

            if (!val1)
                val1 = new Date(9999, 12, 1, 1, 1, 1, item1.ID);
            if (!val2)
                val2 = new Date(9999, 12, 1, 1, 1, 1, item2.ID);

            if (sortAsc)
                return val1.compareTo(val2);

            return val2.compareTo(val1);
        };
        var sortNumber = ganttNamespace.sortNumber = function (sortAsc, sortField, item1, item2) {
            var val1 = item1.data[sortField];
            var val2 = item2.data[sortField];

            if (sortAsc)
                return val1 >= val2;

            return val1 < val2;
        };

        // Сортировка дерева
        // http://stackoverflow.com/questions/8241342/sorting-data-into-a-tree
        function TreeNode(data) {
            this.data     = data;
            this.parent   = null;
            this.children = [];
        }
        TreeNode.prototype.sortRecursive = function (sortMethod) {
            this.children.sort(sortMethod);
            for (var i=0, l=this.children.length; i<l; i++) {
                this.children[i].sortRecursive(sortMethod);
            }
            return this;
        };
        TreeNode.prototype.toArray = function () {
            var arr = [];
            if (this.data) {
                arr.push(this.data);
            }
            for (var i=0, l=this.children.length; i<l; i++) {
                arr = arr.concat(this.children[i].toArray());
            }
            return arr;
        };
        function arrayToTree(data) {
            var nodeById = {};
            var i = 0;
            var l = data.length;
            var node;

            var rootNode = nodeById[0] = new TreeNode(); // that's the root node

            for (i=0; i<l; i++) {  // make TreeNode objects for each item
                nodeById[data[i].ID] = new TreeNode(data[i]);
            }
            for (i=0; i<l; i++) {  // link all TreeNode objects
                node = nodeById[data[i].ID];
                node.parent = nodeById[node.data.ParentId] || rootNode;
                node.parent.children.push(node);
            }
            return nodeById[0];
        }

        // END*****[Posmitniy, 2016-12-23] Сортировка



		function fitGanttViewHeight(){
			var $ganttcontainer = Gantt.$Container;
			$ganttcontainer.bind('ganttViewHeight.resize', function(e){
				setGanttViewHeight($(window).height());
			});
			$(window).resize(function(){
				$ganttcontainer.trigger('ganttViewHeight.resize');
			});
			$ganttcontainer.trigger('ganttViewHeight.resize');
		}

		function setGanttViewHeight(height){
			var toolbarHeight = $('#toolbar').outerHeight() + 2;
			Gantt.$Container.data("GanttControl").setHeight(height - toolbarHeight);
		}

        /*
		//раскраска ридонли
		$('#ganttplace').on('refresh',function(){
			$(this).find('td.rq-grid-cell').has('.not-editable').addClass('not-editable');
		}
		)*/

        function PointEditable(data) {
            return !data.Activity.DataSource.IsMilestone ? 'not-editable' : '';
        }

        function ProjectEditable(data) {
            return data.Activity.DataSource.IsMilestone ? 'not-editable' : '';
        }

        function startDateFormatter(date, data) {
            return "<span class='" + ProjectEditable(data) + "'>" + (data.Activity.DataSource.IsMilestone ?'':Asyst.date.format(date, "dd.MM.yy")) + "</span>";
        }

        function buildLink(data) {
            var link = '/asyst/' + data.Activity.DataSource.EntityName + '/form/auto/' + data.Activity.ID + '?mode=view';
            if (parent !== window)
                link = parent.saveTabAndLink(link);
            return link;
        }

        // Получить колонки для инициализации гриды ганта
        var fillColumns = function (options) {
            // Проверяем - есть ли кастомная настройка колонок
            if (options.columns && options.columns.length) {
                return options.columns;
            }
            
            // Если кастомных колонок нет - возвращаем дефолтные
            return getDefaultColumns();
        };
        // Получить дефолтовые колонки для инициализации гриды ганта
        var getDefaultColumns = ganttNamespace.getDefaultColumns = function () {
            //columns
            var columns = parent.window.ganttColumns = [
            {
                field: "Activity_M().DataSource_M().GetIndicator()",
                title: " ",
                isParentEditable: false,
                template: "<img class='indicator' src='/asyst/gantt/img/${data.Activity_M().DataSource_M().GetIndicator()}.png' title='${data.Activity_M().DataSource_M().IndicatorTitle}'></img>",
                iseditable: false,
                width: 25
            },
//            {
//                field: "Activity_M().PredecessorIndexString_M()",
//                title: "Тип связи",
//                //template: "<span class='${ProjectEditable(data)}'>${data.Activity_M().DataSource_M().PredessesorString}</span>",
//                //editor: "<select class='gantt-select' data-bind='registerPointLinkTypeEditor'></select>",
//                width: 100,
//                //isEditabled: function (smbd) {
//                //    return !smbd.Activity.DataSource.IsMilestone;
//                //},
//                isParentEditable: true,
//            },
            {
                //field: "Activity_M().WBSID_M()",
                field: "Activity.DataSource.WBSID",
                title: "СДР",
                isParentEditable: false,
                iseditable: false,
                //editor: "<input data-bind='value:Activity_M().WBSID_M' />",
                width: 50
            },
            {
                field: "Activity_M().DataSource_M().Code",
                title: "Код",
                isParentEditable: false,
                iseditable: false,
                template: "<a class='code-link' href='${buildLink(data)}'  target='_parent'>${data.Activity_M().DataSource_M().Code}</a>",
                width: 55,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Code',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().ActivityName_M()",
                title: "Наименование",
                width: 300,
                editor: RadiantQ.Default.Template.ProjectGanttExpandableTextboxEditor(),
                template: RadiantQ.Default.Template.ProjectGanttExpandableTextBlockTemplate(),
                /* стандартный темплейт перенаправленный на поле CodeName */
                /*template: '<div class="rq-grid-expand-indentWidth" style="height: 1px; width: ${data.IndentWidth_M()}px"></div><div style="width: 12px; display: ${data.IsParent_M() ? "block" :"none" }" class="arrowContainer">   <div onclick="ExpanderOnclick(this,event)" id="arrow" class="${ data.IsExpanded_M() ? " rq-grid-expand-arrow rq-grid-collapse-arrow": "rq-grid-expand-arrow"} rq-Ignore-click"></div></div> <div class="rq-grid-expander-text">${data.Activity_M().DataSource_M().CodeName}</div>'*/
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Name',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().StartTime_M()",
                title: "Начало<br>(прогноз)",
                width: 100,
                format: "dd.MM.yy",
                template: "${startDateFormatter(data.Activity.StartTime, data)}",
                /*editor: "<input data-bind='ActivityTimeBinder:Activity_M().StartTime_M' />",*/
                //editor: "<input data-bind='value:Activity_M().StartTime' data-getvalueName='getDate' data-setvaluename='setDate'  data-valueUpdate='onBlur'  data-role=\"DateTimePicker\"  />",
                editor: '<input data-bind="dateEditor:Activity.StartTime" type="text" data-field="StartTime"/>',
                isEditabled: function (smbd) {
                    return !smbd.Activity.DataSource.IsMilestone;
                },
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'StartTime',
                sortMethod: sortDateTime
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity.Effort",
                title: "Длит<br>(прогноз)",
                iseditable: false,
                template: "<span class='not-editable'>${data.Activity_M().Effort.days}</span>",
                width: 50,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Effort',
                sortMethod: sortNumber
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().EndTime_M()",
                title: "Окончание<br>(прогноз)",
                width: 100,
                format: "dd.MM.yy",
                //template: "${Asyst.date.format(ganttNamespace.GetAsystEndTime(data.Activity), 'dd.MM.yy')}",
                template: "${data.Activity.DataSource.GetAsystEndTime().toString('dd.MM.yyyy')}",
                //editor: "<input data-bind='value:Activity_M().EndTime' data-getvalueName='getDate' data-setvaluename='setDate'  data-valueUpdate='onBlur'  data-role=\"DateTimePicker\"  />"
                editor: '<input data-bind="dateEditor:Activity.EndTime" type="text" data-field="EndTime"/>',
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'EndTime',
                sortMethod: sortDateTime
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },            
            {
                field: "Activity_M().DataSource_M().FactStartTime",
                title: "Начало<br>(факт)",
                width: 100,
                format: "dd.MM.yy",
                template: "${startDateFormatter(data.Activity.DataSource.FactStartTime, data)}",
                //editor: "<input data-bind='value:Activity.DataSource.FactStartTime' data-getvalueName='getDate' data-setvaluename='setDate'  data-valueUpdate='onBlur'  data-role=\"DateTimePicker\"  />",
                editor: '<input data-bind="dateEditor:Activity.DataSource.FactStartTime" type="text" data-field="FactStartTime"/>',
                isEditabled: function (smbd) {
                    return !smbd.Activity.DataSource.IsMilestone;
                },
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'FactStartTime',
                sortMethod: sortDateTime
                // END*****[Posmitniy, 2016-12-23] Сортировк
            },
            {
                field: "Activity_M().DataSource_M().FactEndTime",
                title: "Окончание<br>(факт)",
                width: 100,
                format: "dd.MM.yy",
                //editor: "<input data-bind='value:Activity.DataSource.FactEndTime' data-getvalueName='getDate' data-setvaluename='setDate' data-valueUpdate='onBlur'  data-role=\"DateTimePicker\"  />"
                editor: '<input data-bind="dateEditor:Activity.DataSource.FactEndTime" type="text" data-field="FactEndTime"/>',
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'FactEndTime',
                sortMethod: sortDateTime
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().ProgressPercent_M()",
                title: "%",
                width: 70,
                editor: "<input data-bind='value:Activity_M().ProgressPercent_M' data-role=\"spinner\" data-options='{\"min\":0, \"max\": 100}' />",
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'ProgressPercent',
                sortMethod: sortNumber
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().PredecessorIndices",
                title: "Предшественники",
                template: "<span'>${data.Activity_M().DataSource_M().GetPredecessorCodes()}</span>",
                editor: "<input class='gantt-select' data-bind='predecessorsEditor:Activity_M().DataSource_M().PredecessorIndices'></input>",
                width: 100,
                isParentEditable: true,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'PredecessorIndices',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().Owner",
                title: "Инициатор",
                iseditable: false,
                template: "<span class='not-editable'>${data.Activity_M().DataSource_M().Owner}</span>",
                width: 100,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Owner',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().Responsible",
                title: "Исполнитель",
                iseditable: false,
                template: "<span class='not-editable'>${data.Activity_M().DataSource_M().Responsible}</span>",
                width: 100,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Responsible',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().Leader",
                title: "Отв. за ввод",
                iseditable: false,
                template: "<span class='not-editable'>${data.Activity_M().DataSource_M().Leader}</span>",
                width: 100,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'Leader',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().PointTypeName",
                title: "Уровень КТ",
                template: "<span class='${PointEditable(data)}'>${data.Activity.DataSource.IsMilestone ? data.Activity.DataSource.PointTypeName : ''}</span>",
                editor: "<select class='gantt-select' data-bind='pointTypeEditor:Activity.DataSource.PointTypeId'></select>",
                width: 100,
                isEditabled: function (smbd) {
                    return smbd.Activity.DataSource.IsMilestone;
                },
                isParentEditable: true,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'PointTypeName',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
            {
                field: "Activity_M().DataSource_M().ProjectStageTypeName",
                title: "Тип этапа",
                template: "<span class='${ProjectEditable(data)}'>${data.Activity_M().DataSource_M().ProjectStageTypeName}</span>",
                editor: "<select class='gantt-select' data-bind='projectStageEditor:Activity.DataSource.ProjectStageTypeId'></select>",
                width: 100,
                isEditabled: function (smbd) {
                    return !smbd.Activity.DataSource.IsMilestone;
                },
                isParentEditable: true,
                // BEGIN*****[Posmitniy, 2016-12-23] Сортировка. Также надо добавить запятую в предыдущей строке.
                sortFieldName: 'ProjectStageTypeName',
                sortMethod: sortText
                // END*****[Posmitniy, 2016-12-23] Сортировка
            },
           
            ];

            return columns;
        }

        var makeTooltips = function () {
            $('a.indicator').tooltip();
        }
        var makeToolbar = function (options) {

            var ganttControl = $('#ganttplace').data("GanttControl");
            var $ganttChart = $('#ganttplace').GanttControl('GetGanttChart');
            var ganttChart = $ganttChart.data("GanttChart");

            var tableContextMenu = ganttControl.TableContextMenu;
            tableContextMenu.AddNewItems([{
                keyName: "OpenInNewTab",
                name: "Открыть в новой вкладке",
                icon: "OpenInNewTab",
                callback: function (key, opt) {
                    var dataContext = ganttChart.GetDataFromRow(opt.$trigger[0]);
                    var win = window.open(buildLink(dataContext), '_blank');
                    win.focus();
                }
            }],false);


            var buttons = (options.getToolbarButtons && typeof options.getToolbarButtons === 'function')
                ? options.getToolbarButtons(Gantt)
                : getDefaultToolbarButtons(Gantt);

            var toolbarhtml = '<ul class="top-menu">';
            //var toolbarhtml = '';
            for (var i = 0; i < buttons.length; i++) {
                var button = buttons[i];
                toolbarhtml += '<li><div class="c-btn ' + button.class + '" title="' + button.title + '"><a id="' + button.id + '" class="link' + ((!button.func) ? ' disabled' : ' ') + '" ></a></div></li>';
            }

            toolbarhtml += '<li><input class="c-btn srch" id="nameField"  type="text" onkeyup="Gantt.Control.Filter()" /></li>';

            toolbarhtml += '</ul>';
            $('#toolbar').html(toolbarhtml);
            for (var i = 0; i < buttons.length; i++) {
                $('#' + buttons[i].id).on('click', buttons[i].func);
            }

            $('li>div.c-btn').tooltip({ placement: 'bottom' });

        }

        // Получить дефолтные кнопки для панели инструментов
        var getDefaultToolbarButtons = ganttNamespace.getDefaultToolbarButtons = function(gantt) {
            var ganttControl = gantt.Control;
            var buttons = [
                {
                    id: 'tbBtnCreatePoint',
                    func: function () {
                        if (parent === window || !parent.GanttCreatePointt) {
                            alert('Не найдена функция создания точек. Возможно, календарный план открыт не в карточке!')
                        }
                        else {
                            var activity = ganttControl.SelectedActivity;
                            parent.GanttCreatePointt(activity ? (activity.Parent ? activity.Parent.ID : null) : null, true, addPointFromForm, null);
                        }
                    },
                    title: 'Создать точку',
                    class: 'gantt-add-milestone',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных

                },
                {
                    id: 'tbBtnCreateTask',
                    func: function () {
                        if (parent === window || !parent.GanttCreatePointt) {
                            alert('Не найдена функция создания работ. Возможно, календарный план открыт не в карточке!')
                        }
                        else {
                            var activity = ganttControl.SelectedActivity;
                            parent.GanttCreatePointt(activity ? (activity.Parent ? activity.Parent.ID : null) : null, false, addPointFromForm, null);
                        }
                    },
                    title: 'Создать этап или работу',
                    class: 'gantt-add-task',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                /*
                {id: 'tbBtnDelete',
                 func: function() {
                    var activity = ganttControl.SelectedActivity;
                    if (activity) {
                        var ganttItemSource = ganttControl.options.DataSource;
                        ganttControl.RemoveActivity(activity.ID_M());
                    }
                    else
                        alert("Необходимо выделить работу.");
                 },
                 title: 'Удалить'                ,
                 isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },*/
                {
                    id: 'tbBtnLevelUp',
                    func: function () {                        
                        var activityview = ganttControl.SelectedItem_M();
                        var activity = activityview.Activity;
                        if (!activityview || activity.IndentLevel == 0) {
                            alert("Повысить уровень этой работы уже не возможно.");
                        } else if (activity.IsMilestone && activity.Parent.ChildActivities.findIndex(function (a) { return a == activity }) !== activity.Parent.ChildActivities.length - 1) {
                            alert("Нельзя сделать КТ суммарной задачей.");
                        } else {
                            Gantt.BeginUpdate();
                            try {
                                ganttControl.Outdent(activityview);

                                // aposmitniy, 2017-01-27
                                activity.DataSource.ParentId = activity.Parent ? activity.Parent.ID : null;
                            } finally {
                                Gantt.EndUpdate();
                            }
                        }

                        return false;
                    },
                    title: 'Повысить уровень', //влево
                    class: 'gantt-level-up first',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnLevelDown',
                    func: function () {    
                        var checkInDependency = function (checkId) {
                            var result = false;
                            var model = ganttControl.Model;
                            for (var i = 0; i < model.Dependencies.length; i++) {
                                var item = model.Dependencies[i];
                                if (item.FromActivity.ID == checkId || item.ToActivity.ID == checkId) {
                                    result = true;
                                    break;
                                }
                            }
                            return result;
                        }
                        var activityview = ganttControl.SelectedItem_M();
                        var activity = activityview.Activity;
                        var model = ganttControl.Model;
                        var flag = true;
                        var activities;
                        if (activity.Parent === undefined || activity.Parent === null) {                            
                            activities = ganttControl.Model.Activities;
                        }
                        else {
                            activities = activity.Parent.ChildActivities;
                        }

                        for (var i = 0; i < activities.length; i++) {
                            if (activities[i] === activity) {
                                if (i == 0) {
                                    flag = false;
                                    alert("Невозможно понизить уровень первой задачи");
                                }
                                else if (activities[i - 1].DataSource.IsMilestone) {
                                    flag = false;
                                    alert("Невозможно сделать веху суммарной задачей");
                                }
                                //else if (checkInDependency(activities[i - 1].ID) || activities[i - 1].PredecessorIndexString) {
                                else if (model.Dependencies.GetDependenciesByActivity(activities[i - 1]) || activities[i - 1].PredecessorIndexString) {
                                    flag = false;
                                    alert("Невозможно сделать суммарной задачу со связью");
                                }

                                break;
                            }
                        }
                        
                        if (flag) {
                            Gantt.BeginUpdate();
                            try {
                                ganttControl.Indent(activityview);
                                
                                // aposmitniy, 2017-01-27
                                activity.DataSource.ParentId = activity.Parent.ID;
                            } finally {
                                Gantt.EndUpdate();
                            }
                        } 
                        return false;
                    },
                    title: 'Понизить уровень', //вправо
                    class: 'gantt-level-down',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnUp',
                    func: function () {
                        var table = ganttControl.GetGanttTable();
                        var selItem = ganttControl.SelectedItem_M();
                        if (ganttControl.SelectedIndex_M() != -1) {
                            Gantt.BeginUpdate();
                            try {
                                table.MoveRows(ganttControl.SelectedIndex_M(), 1, ganttControl.SelectedIndex_M() - 2);
                                ganttControl.SelectedItem = selItem;
                            } finally {
                                Gantt.EndUpdate();
                            }
                        } else
                            alert("Необходимо выделить работу.");
                        return false;
                    },
                    title: 'Вверх',
                    class: 'gantt-up first'
                },
                {
                    id: 'tbBtnDown',
                    func: function () {
                        var table = ganttControl.GetGanttTable();
                        var selItem = ganttControl.SelectedItem_M();
                        if (selItem != null) {
                            var selIndex = ganttControl.SelectedIndex_M();
                            if (selIndex > -1) {
                                Gantt.BeginUpdate();
                                try {
                                    table.OnBeforeDragStart(selIndex, 1);
                                    var selCount = ganttControl.SelectedItems.length;
                                    table.MoveRows(selIndex, selCount, selIndex + selCount);
                                    ganttControl.SelectedItem = selItem;
                                } finally {
                                    Gantt.EndUpdate();
                                }
                            }
                        }
                        else
                            alert("Необходимо выделить работу.");

                        return false;
                    },
                    title: 'Вниз',
                    class: 'gantt-down',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnCollapseAll',
                    func: function () {
                        ganttControl.CollapseAll();
                    },
                    title: 'Свернуть всё',
                    class: 'gantt-collapse first',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnExpandAll',
                    func: function () {
                        ganttControl.ExpandAll();
                    },
                    title: 'Развернуть всё',
                    class: 'gantt-expand',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                /*{id: 'tbBtnMonth',
                 func: null,
                 title: 'Месяц'
                },
                {id: 'tbBtnQuarter',
                 func: null,
                 title: 'Квартал'
                },
                {id: 'tbBtnHalfYear',
                 func: null,
                 title: 'Полугодие'
                },
                {id: 'tbBtnYear',
                 func: null,
                 title: 'Год'
                },*/
                {
                    id: 'tbBtnFitToWindow',
                    func: function ganttFitToWindow() { Gantt.FitToWindow() },
                    title: 'Всё',
                    class: 'gantt-view-all first',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnZoomIn',
                    func: Gantt.ZoomIn,
                    title: 'Увеличить',
                    class: 'gantt-zoom-in',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnZoomOut',
                    func: Gantt.ZoomOut,
                    title: 'Уменьшить',
                    class: 'gantt-zoom-out',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnShowCriticalPath',
                    func: function updateCriticalPaths(sender, e) {
                        // The first argument to GetCriticalPathActivities is a time-buffer which speifies the "safe distance"
                        // that an activity's end time should be away from affecting the project deadline.
                        Gantt.CriticalPathActivities = ganttControl.GetCriticalPathActivities(RQTimeSpan.Zero_M());
                        ganttControl.RedrawChartRows();
                    },

                    title: 'Рассчитать критический путь',
                    class: 'gantt-create-critical first',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnHideCricitalPath',
                    func: function clearCriticalPaths(sender, e) {
                        Gantt.CriticalPathActivities = [];
                        ganttControl.RedrawChartRows();
                    },
                    title: 'Скрыть критический путь',
                    class: 'gantt-remove-critical',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnMPP',
                    func: function () {                        
                        var name = parent.Asyst.Workspace.currentForm.Data.Code;
                        var settings = {
                            service: '/asystSPUtil/MPP/Export.asmx', method: 'ExportMPP',
                            params: { sp: 'card_mppExport @ActivityId=' + parent.Asyst.Workspace.currentForm.Data.ActivityId, templateUrl: 'asyst/WindowsLogin.aspx?authSelect=true&ReturnUrl=%2fasyst%2fapi%2ffile%2fget%2f21131021-ce82-459e-ac5d-24fff134ec2a%2ftemplateclear.mpp', filePrefix: name }, tooltip: "Выполняется выгрузка календарного плана в файл Project"
                        };
                        CallService.FormInvoke(settings);
                    },
                    title: 'Экспорт в project (*.mpp)',
                    class: 'project-export first',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnMPPImport',
                    func: function () {
                        parent.Asyst.importMPP.Create({
                            elem: '#tbBtnMPPImport', activityId: parent.Asyst.Workspace.currentForm.Data.ActivityId, profiles: [{ id: 'TaskAndDates', name: 'Первичная загрузка (в файле должны быть Название, Базовые, Плановые, Фактические даты (если применимо); структура и связи; роли унаследуются из проекта)' },
                                { id: 'TaskAndDatesAndPersons', name: 'Первичная загрузка (в файле должны быть Название, Базовые, Плановые, Фактические даты (если применимо); структура и связи; Инициатор, Исполнитель, Ответственный за ввод - названиям, как в карточках сотрудников)' },
                                { id: 'TaskAndDatesUpdate', name: 'Обновление данных (в файле должны быть ИД карточки; Название, Базовые, Плановые, Фактические даты (если применимо); структура и связи; роли новых унаследуются из проекта)' },
                                { id: 'TaskAndDatesAndPersonsUpdate', name: 'Обновление данных (в файле должны быть ИД карточки; Название, Базовые, Плановые, Фактические даты (если применимо); структура и связи; Инициатор, Исполнитель, Ответственный за ввод - названиям, как в карточках сотрудников)' }

                            ], context: window

                        });
                    },
                    title: 'Импорт из project (*.mpp)',
                    class: 'project-import',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbBtnXLS',
                    func: function () {
                        var name = parent.Asyst.Workspace.currentForm.Data.Code + "-" + parent.Asyst.date.format(new Date(), "yyyyMMddhhmm") + ".xlsx";
                        var id = parent.Asyst.Workspace.currentForm.Data.ActivityId;
                        Asyst.APIv2.View.load({ viewName: 'NewGantt', data: { ActivityId: id }, success: function(result) { ViewExport(parent.Asyst.Workspace.currentForm.Data.Code, result); }, async: false });
                    },
                    title: 'Экспорт в excel (*.xlsx)',
                    class: 'excel-export',
                    isReadonly: true //действие может выполняться в режиме readonly, т.е. не меняет данных
                },
                {
                    id: 'tbCopyForecastToPlan',
                    func: function () {
                        var id = 'confirmcopy';
                        parent.Dialogs.Confirm('Подтверждение', 'Вы уверены, что хотите сохранить базовый план (скопировать данные из прогноза в план для всех этапов, работ и точек проекта)?', function () {
                            var form = parent.Asyst.Workspace.currentForm;
                            //form.ProcessHandler(form.Handlers['ehCopyForecast'], { ActivityId: form.Data.ActivityId });
                            /*Asyst.APIv2.Form.handlerAction({
                                    formName: form.FormName,
                                    handlerName: 'ehCopyForecast',
                                    actionId: 'cfc8b6d7-ec21-4b12-831b-c57b5283aba4',
                                    checked: true,
                                    data: { ActivityId: form.Data.ActivityId },
                                    async: true,*/
                            Asyst.APIv2.DataSet.load({
                                    name: "CopyForecast",
                                    data: {
                                        ActivityId: self.Gantt.ActivityId
                                    },
                                    success: function() {
                                        parent.$('#' + id).modal('hide');
                                        Gantt.reload();
                                    }
                                }
                            );
                        }, null, id);

                    },
                    title: 'Сохранить базовый план (скопировать прогноз в план)',
                    class: 'gantt-copy-base first',
                    isReadonly: false //действие может выполняться в режиме readonly, т.е. не меняет данных
                }

            ];

            // Фильтруем кнопки по настройке readonly ганта
            if (ganttControl.IsReadOnly) {
                return buttons.filter(function(val) { return val.hasOwnProperty('isReadonly') && val.isReadonly });
            } else {
                return buttons;
            }
        }


        var addPointFromForm = function (data) {
            Asyst.debugger('imw');
            var item = Gantt.CreateItem(data, true);

            var activity = Gantt.Control.SelectedActivity;

            var parentId = activity ? (activity.Parent ? activity.Parent.ID : null) : null;
            var newParentId = data.Parent ? data.Parent.ActivityId : null;

            if (Gantt.Control.Model) {
                if (parentId && parentId != newParentId) {
                    if (newParentId) {
                        activity = Gantt.Control.Model.ActivityById[newParentId];
                        if (activity) {
                            Gantt.Control.InsertNewItemAsChildOf(item, activity.DisplayIndex, true);
                            return item;
                        };
                    } else {
                        activity = null;
                    };
                } else if (!parentId && newParentId) {
                    activity = Gantt.Control.Model.ActivityById[newParentId];
                    if (activity) {
                        Gantt.Control.InsertNewItemAsChildOf(item, activity.DisplayIndex, true);
                    } else {
                        Gantt.Control.AddNewItem(item);
                    };
                    return item;
                };
                if (activity) {
                    Gantt.Control.InsertNewItemAsSiblingBelow(item, activity.DisplayIndex, true);
                } else {
                    Gantt.Control.AddNewItem(item);
                };
            } else {
                Gantt.reload();
            }

            return item;
        };


	</script>

</body>

</html>	